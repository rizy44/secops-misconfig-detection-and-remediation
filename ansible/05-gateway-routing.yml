---
- name: Configure Gateway Routing
  hosts: gateway
  become: yes
  vars:
    private_net_cidr: "10.10.51.0/24"  # a-subnet-private CIDR
    secops_net_cidr: "10.10.50.0/24"   # secops-subnet CIDR
  
  tasks:
    - name: Enable IP forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
        sysctl_set: yes
        reload: yes

    - name: Enable IP forwarding on boot
      lineinfile:
        path: /etc/sysctl.conf
        line: 'net.ipv4.ip_forward=1'
        regexp: '^net.ipv4.ip_forward'
        state: present

    - name: Get interface names
      shell: |
        ip -o link show | awk -F': ' '{print $2}' | grep -E '^eth|^ens' | sort
      register: interfaces
      changed_when: false

    - name: Set interface facts (eth0 = secops-net, eth1 = private-net)
      set_fact:
        secops_interface: "eth0"
        private_interface: "eth1"

    - name: Configure iptables NAT for private network
      iptables:
        table: nat
        chain: POSTROUTING
        source: "{{ private_net_cidr }}"
        out_interface: "{{ secops_interface }}"
        jump: MASQUERADE
        comment: "NAT for private network to secops-net"

    - name: Allow forwarding from private to secops
      iptables:
        chain: FORWARD
        in_interface: "{{ private_interface }}"
        out_interface: "{{ secops_interface }}"
        jump: ACCEPT
        comment: "Forward from private to secops"

    - name: Allow forwarding from secops to private (established)
      iptables:
        chain: FORWARD
        in_interface: "{{ secops_interface }}"
        out_interface: "{{ private_interface }}"
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT
        comment: "Forward from secops to private (established)"

    - name: Allow forwarding from secops to private (new connections)
      iptables:
        chain: FORWARD
        in_interface: "{{ secops_interface }}"
        out_interface: "{{ private_interface }}"
        jump: ACCEPT
        comment: "Forward from secops to private (new connections)"

    - name: Update apt cache
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install iptables-persistent
      apt:
        name: iptables-persistent
        state: present
      when: ansible_os_family == "Debian"
      ignore_errors: yes

    - name: Create /etc/iptables directory
      file:
        path: /etc/iptables
        state: directory
        mode: "0755"
      when: ansible_os_family == "Debian"

    - name: Save iptables rules
      shell: iptables-save > /etc/iptables/rules.v4
      when: ansible_os_family == "Debian"
      changed_when: false

    - name: Enable netfilter-persistent service (if installed)
      systemd:
        name: netfilter-persistent
        enabled: yes
        state: started
      when: ansible_os_family == "Debian"
      ignore_errors: yes

    - name: Create systemd service for iptables restore
      copy:
        dest: /etc/systemd/system/iptables-restore.service
        content: |
          [Unit]
          Description=Restore iptables rules
          Before=network-pre.target
          Wants=network-pre.target

          [Service]
          Type=oneshot
          ExecStart=/sbin/iptables-restore /etc/iptables/rules.v4
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target
        mode: "0644"
      when: ansible_os_family == "Debian"

    - name: Enable iptables-restore service
      systemd:
        name: iptables-restore
        enabled: yes
        daemon_reload: yes
      when: ansible_os_family == "Debian"
      ignore_errors: yes

- name: Configure Private VM Routing
  hosts: private_vm
  become: yes
  vars:
    secops_net_cidr: "10.10.50.0/24"
    private_net_cidr: "10.10.51.0/24"
  
  tasks:
    - name: Get gateway private IP from inventory
      set_fact:
        gateway_private_ip: "{{ hostvars[groups['gateway'][0]]['gateway_private_ip'] | default('') }}"

    - name: Find gateway IP on private network (via ARP table)
      shell: |
        # Try to find gateway IP by checking ARP entries in private network range
        ip neigh show | grep "10.10.51" | head -1 | awk '{print $1}' || echo ""
      register: arp_gateway_ip
      changed_when: false
      failed_when: false

    - name: Ping gateway to populate ARP (if needed)
      command: ping -c 1 -W 1 {{ hostvars[groups['gateway'][0]]['ansible_host'] }}
      when: arp_gateway_ip.stdout == ""
      changed_when: false
      failed_when: false
      ignore_errors: yes

    - name: Get gateway IP from ARP after ping
      shell: |
        ip neigh show | grep "10.10.51" | head -1 | awk '{print $1}' || echo ""
      register: arp_gateway_ip_after
      when: arp_gateway_ip.stdout == ""
      changed_when: false
      failed_when: false

    - name: Set final gateway IP (prefer inventory, fallback to ARP, then default)
      set_fact:
        final_gateway_ip: "{{ gateway_private_ip | default(arp_gateway_ip_after.stdout | default(arp_gateway_ip.stdout) | default('10.10.51.1')) }}"

    - name: Debug gateway IP
      debug:
        msg: "Using gateway IP on private network: {{ final_gateway_ip }}"

    - name: Check current default route
      shell: ip route | grep default | awk '{print $3}' || echo "none"
      register: current_default_gw
      changed_when: false
      failed_when: false

    - name: Add default route via gateway (if not exists)
      shell: |
        ip route add default via {{ final_gateway_ip }} || true
      when: current_default_gw.stdout == "none" or current_default_gw.stdout != final_gateway_ip
      changed_when: true
      failed_when: false

    - name: Check if route to secops-net exists
      shell: ip route show | grep -q "{{ secops_net_cidr }}" || echo "not_found"
      register: route_check
      changed_when: false
      failed_when: false

    - name: Add route to secops-net via gateway
      shell: |
        ip route add {{ secops_net_cidr }} via {{ final_gateway_ip }} || true
      when: route_check.stdout == "not_found"
      changed_when: true
      failed_when: false
