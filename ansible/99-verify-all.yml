---
# Playbook kiểm tra toàn bộ hệ thống
- name: Verify System Health
  hosts: all
  become: true
  gather_facts: yes
  tasks:
    - name: Kiểm tra kết nối và thông tin cơ bản
      block:
        - name: Hiển thị hostname và IP
          debug:
            msg: "Host: {{ inventory_hostname }} - IP: {{ ansible_host }} - Private IP: {{ private_ip | default('N/A') }}"

        - name: Kiểm tra uptime
          command: uptime
          register: uptime_result
          changed_when: false

        - name: Hiển thị uptime
          debug:
            var: uptime_result.stdout

        - name: Kiểm tra disk space
          shell: df -h /
          register: disk_result
          changed_when: false

        - name: Hiển thị disk space
          debug:
            var: disk_result.stdout

        - name: Kiểm tra memory
          shell: free -h
          register: mem_result
          changed_when: false

        - name: Hiển thị memory
          debug:
            var: mem_result.stdout

- name: Verify Docker và Containers
  hosts: all
  become: true
  tasks:
    - name: Kiểm tra Docker service status
      systemd:
        name: docker
      register: docker_status

    - name: Hiển thị Docker status
      debug:
        msg: "Docker service: {{ docker_status.status.ActiveState }}"

    - name: Kiểm tra Docker version
      command: docker --version
      register: docker_version
      changed_when: false

    - name: Hiển thị Docker version
      debug:
        var: docker_version.stdout

    - name: Kiểm tra Docker Compose version
      command: docker compose version
      register: compose_version
      changed_when: false
      ignore_errors: yes

    - name: Hiển thị Docker Compose version
      debug:
        var: compose_version.stdout

    - name: Liệt kê tất cả containers
      shell: docker ps -a
      register: containers
      changed_when: false

    - name: Hiển thị containers
      debug:
        var: containers.stdout

- name: Verify OBS Stack Services (Gateway)
  hosts: obs_stack
  become: true
  tasks:
    - name: Kiểm tra containers OBS Stack
      shell: |
        cd /opt/obs-stack
        docker compose ps
      register: obs_containers
      changed_when: false

    - name: Hiển thị OBS Stack containers
      debug:
        var: obs_containers.stdout

    - name: Kiểm tra Prometheus endpoint
      uri:
        url: "http://localhost:9090/-/healthy"
        method: GET
        status_code: [200]
        timeout: 5
      register: prometheus_check
      ignore_errors: yes

    - name: Hiển thị Prometheus status
      debug:
        msg: "Prometheus health: {{ 'OK' if prometheus_check.status == 200 else 'FAILED' }}"

    - name: Kiểm tra Loki endpoint
      uri:
        url: "http://localhost:3100/ready"
        method: GET
        status_code: [200]
        timeout: 5
      register: loki_check
      ignore_errors: yes

    - name: Hiển thị Loki status
      debug:
        msg: "Loki ready: {{ 'OK' if loki_check.status == 200 else 'FAILED' }}"

    - name: Kiểm tra Grafana endpoint
      uri:
        url: "http://localhost:3000/api/health"
        method: GET
        status_code: [200]
        timeout: 5
      register: grafana_check
      ignore_errors: yes

    - name: Hiển thị Grafana status
      debug:
        msg: "Grafana health: {{ 'OK' if grafana_check.status == 200 else 'FAILED' }}"

    - name: Kiểm tra Alertmanager endpoint
      uri:
        url: "http://localhost:9093/-/healthy"
        method: GET
        status_code: [200]
        timeout: 5
      register: alertmanager_check
      ignore_errors: yes

    - name: Hiển thị Alertmanager status
      debug:
        msg: "Alertmanager health: {{ 'OK' if alertmanager_check.status == 200 else 'FAILED' }}"

- name: Verify SecOps App
  hosts: secops_app
  become: true
  tasks:
    - name: Kiểm tra containers SecOps App
      shell: |
        cd /opt/secops/secops_app
        docker compose ps
      register: secops_containers
      changed_when: false

    - name: Hiển thị SecOps containers
      debug:
        var: secops_containers.stdout

    - name: Kiểm tra SecOps API endpoint
      uri:
        url: "http://localhost:8000/metrics"
        method: GET
        status_code: [200]
        timeout: 5
      register: secops_api_check
      ignore_errors: yes

    - name: Hiển thị SecOps API status
      debug:
        msg: "SecOps API: {{ 'OK' if secops_api_check.status == 200 else 'FAILED' }}"

    - name: Test SecOps API metrics endpoint
      shell: curl -s http://localhost:8000/metrics | head -5
      register: metrics_output
      changed_when: false
      ignore_errors: yes

    - name: Hiển thị metrics sample
      debug:
        var: metrics_output.stdout

    - name: Kiểm tra OpenRC file tồn tại
      stat:
        path: /opt/secops/tenantA-openrc.sh
      register: openrc_file

    - name: Hiển thị OpenRC status
      debug:
        msg: "OpenRC file: {{ 'EXISTS' if openrc_file.stat.exists else 'MISSING' }}"

- name: Verify Monitoring Agents
  hosts: "secops_app:obs_stack:workload"
  become: true
  tasks:
    - name: Kiểm tra agents containers
      shell: |
        cd /opt/agents
        docker compose ps
      register: agents_containers
      changed_when: false
      ignore_errors: yes

    - name: Hiển thị agents containers
      debug:
        var: agents_containers.stdout

    - name: Kiểm tra node_exporter endpoint
      uri:
        url: "http://localhost:9100/metrics"
        method: GET
        status_code: [200]
        timeout: 5
      register: node_exporter_check
      ignore_errors: yes

    - name: Hiển thị node_exporter status
      debug:
        msg: "node_exporter on {{ inventory_hostname }}: {{ 'OK' if node_exporter_check.status == 200 else 'FAILED' }}"

    - name: Kiểm tra promtail endpoint
      uri:
        url: "http://localhost:9080/ready"
        method: GET
        status_code: [200]
        timeout: 5
      register: promtail_check
      ignore_errors: yes

    - name: Hiển thị promtail status
      debug:
        msg: "promtail on {{ inventory_hostname }}: {{ 'OK' if promtail_check.status == 200 else 'FAILED' }}"

- name: Verify Network Connectivity
  hosts: all
  become: true
  tasks:
    - name: Kiểm tra ping gateway từ các máy
      ping:
      delegate_to: "{{ groups['gateway'][0] }}"
      when: inventory_hostname != groups['gateway'][0]
      ignore_errors: yes

    - name: Kiểm tra kết nối đến Prometheus từ các máy
      uri:
        url: "http://{{ hostvars[groups['obs_stack'][0]].private_ip }}:9090/-/healthy"
        method: GET
        timeout: 5
      register: prometheus_remote_check
      ignore_errors: yes
      when: inventory_hostname != groups['obs_stack'][0]

    - name: Hiển thị kết nối Prometheus từ xa
      debug:
        msg: "Remote Prometheus access from {{ inventory_hostname }}: {{ 'OK' if prometheus_remote_check.status == 200 else 'FAILED' }}"
      when: inventory_hostname != groups['obs_stack'][0]

    - name: Kiểm tra kết nối đến Loki từ các máy
      uri:
        url: "http://{{ hostvars[groups['obs_stack'][0]].private_ip }}:3100/ready"
        method: GET
        timeout: 5
      register: loki_remote_check
      ignore_errors: yes
      when: inventory_hostname != groups['obs_stack'][0]

    - name: Hiển thị kết nối Loki từ xa
      debug:
        msg: "Remote Loki access from {{ inventory_hostname }}: {{ 'OK' if loki_remote_check.status == 200 else 'FAILED' }}"
      when: inventory_hostname != groups['obs_stack'][0]

