- hosts: obs_stack
  become: true
  tasks:
    - name: Create project dir
      file:
        path: /opt/obs-stack
        state: directory

    - name: Ensure /data exists
      file:
        path: /data
        state: directory

    - name: Ensure data dirs exist (demo perms)
      file:
        path: "{{ item }}"
        state: directory
        mode: "0777"
      loop:
        - /data/prometheus
        - /data/loki
        - /data/grafana
        - /data/alertmanager

    - name: Render prometheus.yml from inventory private_ip
      template:
        src: templates/prometheus.yml.j2
        dest: /opt/obs-stack/prometheus.yml

    - name: Render docker-compose.yml
      template:
        src: templates/docker-compose.yml.j2
        dest: /opt/obs-stack/docker-compose.yml

    - name: Copy loki config
      copy:
        src: templates/loki-config.yml
        dest: /opt/obs-stack/loki-config.yml

    - name: Copy alertmanager config
      copy:
        src: templates/alertmanager.yml
        dest: /opt/obs-stack/alertmanager.yml

    - name: Restart obs stack
      shell: |
        cd /opt/obs-stack
        docker compose down
        docker compose up -d
      args:
        executable: /bin/bash

    - name: Show status
      shell: |
        cd /opt/obs-stack
        docker compose ps
      register: psout
      changed_when: false

    - debug:
        var: psout.stdout
